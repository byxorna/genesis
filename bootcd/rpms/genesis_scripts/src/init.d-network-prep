#! /bin/bash
#
# chkconfig: 2345 09 89
# descripttion: setup network interfaces for dhclient to configure
#
# these should be a better way to do this.  TODO find it!

### BEGIN INIT INFO
# X-Start-Before:    $network
# Default-Start:     2 3 4 5
# Description:       setup network interfaces for dhclient to configure
### END INIT INFO

case "$1" in
  start)
    # bring up the correct partition
    if [[ -d /sys/class/net/ib0 ]] ; then
      set -e
      echo "Creating infiniband partition 2 on ib0"
      echo 2 > /sys/class/net/ib0/create_child
      stat /sys/class/net/ib0.8002
    else
      echo "Unable to find ib0! Unable to create child interface. FUCK!"
    fi

    for f in /sys/class/net/* ; do
      iface="$(basename $f)"
      if [[ $iface != lo ]] ; then
        cat > /etc/sysconfig/network-scripts/ifcfg-$iface <<EOF
DEVICE=$iface
BOOTPROTO=dhcp
ONBOOT=no
NAME=nic
EOF
        if [[ -z "$network_up" ]] ; then
          echo "DHCPing on $iface"
          /sbin/dhclient -1 -timeout 15 $iface && network_up="$iface" && ip -o -4 a show dev $iface
        fi
      fi
    done
  ;;
  *)  ;;
esac

exit 0
